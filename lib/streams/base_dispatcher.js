"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();Object.defineProperty(exports,"__esModule",{value:!0});var _chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_stripAnsi=require("strip-ansi"),_stripAnsi2=_interopRequireDefault(_stripAnsi),_actions=require("../actions"),_errors=require("../errors"),_stream=require("stream"),BaseDispatcher=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,{objectMode:!0}));if(r.name="dispatcher",r.filters={},r.params={},r.done=null,r.skipThen=!1,r.endAction=null,r._results=[],e.route&&(r.params.route=e.route),e.store&&(r.store=e.store),!r.store)throw new Error("BaseDispatcher: No store provided");return r.on("error",function(e){process.stderr.write((e.stack||e.message)+"\n")}),r.once("finish",function(){return r.select("currentPage.isNavigating")&&r.removeAllListeners("finish"),r.endAction?void r.endAction():void 0}),"function"==typeof r.params.route&&r.once("finish",function(){var e=r.getLastResult(),t=e.creator,n=e.type,i=e.data,s=e.params;(t||i)&&r.params.route(t,n,i,s)&&(r.skipThen=!0)}),r}return _inherits(t,e),_createClass(t,[{key:"dispatch",value:function(e){return this.store.dispatch(e)}},{key:"displayError",value:function(e){var t=e.message;return e instanceof _errors.MatchError&&(t=this.formatError(e.message)),process.stderr.write(_chalk2["default"].red.bold(t)+"\n"),!1}},{key:"finish",value:function(){return this.done()}},{key:"formatError",value:function(e){var t=(0,_stripAnsi2["default"])(e).trim();return t&&(t=" ("+t+")"),"Huh"+t+"?"}},{key:"getLastResult",value:function(){return this._results.length?this._results[this._results.length-1]:{}}},{key:"route",value:function(e){var t=this,r=e.type,n=e.data,i=e.params,s=this.select("currentPage.name");if("blank"===n.operation&&"index"!==s)return this.endAction=function(){t.removeAllListeners("finish"),t.dispatch((0,_actions.navigate)("index"))},!0;if(n.type&&"all"===n.type&&"file"===r&&1===i.queryCount&&"index"!==s&&"directories"!==s)return this.endAction=function(){t.dispatch((0,_actions.navigate)("index")),t.removeAllListeners("finish")},this.updateFile(n),!0;switch(r){case"error":return this._results.pop(),this.displayError(n);case"file":return this.updateFile(n)}}},{key:"select",value:function(e){var t=this.store.getState();return e.split(".").map(function(e){t=t[e]}),t}},{key:"then",value:function(e){var t=this;this.once("finish",function(){t.select("currentPage.isNavigating")||t.skipThen||e(t._results)})}},{key:"updateFile",value:function(e){var t=e.operation,r=e.value,n="unselect"===t?_actions.removeFile:_actions.addFile;return this.dispatch(n(r)),!1}},{key:"_write",value:function(e,t,r){return this._results.push(e),this.route(e)&&(this.skipThen=!0),this.done=r,this.finish()}}]),t}(_stream.Writable);exports["default"]=BaseDispatcher;